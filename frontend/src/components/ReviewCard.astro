---
import { type Review, RatingEnum } from '../types';

interface Props {
  review: Review;
}

const { review } = Astro.props;

const getRatingStyle = (rating: number) => {
  switch (rating) {
    case RatingEnum.ABISMO: return { label: "ABISMO", color: "bg-red-700 text-white", icon: "ðŸ’€" };
    case RatingEnum.NAO_E_PRA_MIM: return { label: "NÃƒO Ã‰ PRA MIM", color: "bg-orange-500 text-black", icon: "ðŸ˜" };
    case RatingEnum.ESQUECIVEL: return { label: "ESQUECÃVEL", color: "bg-gray-400 text-black", icon: "â˜ï¸" };
    case RatingEnum.MANEIRO: return { label: "MANEIRO", color: "bg-green-600 text-white", icon: "ðŸ”¥" };
    case RatingEnum.PEAK_FICTION: return { label: "PEAK FICTION", color: "bg-purple-700 text-white", icon: "ðŸ‘‘" };
    default: return { label: "???", color: "bg-gray-200", icon: "?" };
  }
};

const style = getRatingStyle(review.rating);
const formattedDate = new Date(review.created_at).toLocaleDateString('pt-BR');

const tags = review.tags_list.split(',').map(tag => tag.trim());
---

<article class="border-2 border-[#306f74] bg-stone-950 hover:translate-y-0.5 transition-all duration-75 flex flex-col h-full font-mono">
  
  <div class="bg-[#306f74] text-white px-2 py-1 flex justify-between items-center border-b-2 border-black">
    <span class="font-bold truncate text-sm uppercase">{review.content_type} // {review.id}</span>

    <button 
      class="share-btn cursor-pointer hover:scale-110 active:scale-90 transition-transform text-sm" 
      data-url={`/review/${review.id}`}
      title="Copiar Link"
    >
      <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="16" height="16" viewBox="0,0,256,256">
        <g fill="#ffffff" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(9.84615,9.84615)"><path d="M21,0c-2.76172,0 -5,2.23828 -5,5c0,0.08594 0.02734,0.16406 0.03125,0.25l-7.84375,3.9375c-0.86719,-0.73047 -1.96484,-1.1875 -3.1875,-1.1875c-2.76172,0 -5,2.23828 -5,5c0,2.76172 2.23828,5 5,5c1.22266,0 2.32031,-0.45703 3.1875,-1.1875l7.84375,3.9375c-0.00391,0.08594 -0.03125,0.16406 -0.03125,0.25c0,2.76172 2.23828,5 5,5c2.76172,0 5,-2.23828 5,-5c0,-2.76172 -2.23828,-5 -5,-5c-1.22266,0 -2.32031,0.45703 -3.1875,1.1875l-7.84375,-3.9375c0.00391,-0.08594 0.03125,-0.16406 0.03125,-0.25c0,-0.08594 -0.02734,-0.16406 -0.03125,-0.25l7.84375,-3.9375c0.86719,0.73047 1.96484,1.1875 3.1875,1.1875c2.76172,0 5,-2.23828 5,-5c0,-2.76172 -2.23828,-5 -5,-5z"></path></g></g>
      </svg>
    </button>
  </div>

  <div class="p-4 flex flex-col gap-4 grow">
    
    <div class="relative group border-2 border-stone-950 overflow-hidden h-48 bg-gray-300">
        <div class="w-full h-full">
            <img 
                src={review.cover_image_url} 
                alt={review.title} 
                class="w-full h-full object-cover"
            />
        </div>
        
        <div class={`absolute bottom-0 right-0 px-2 py-1 border-t-2 border-l-2 border-stone-950 font-bold text-sm flex items-center gap-2 ${style.color}`}>
            <span>{style.icon}</span>
            <span>{style.label}</span>
        </div>
    </div>

    <div>
        <h2 class="text-lg font-bold leading-tight mb-1">{review.title}</h2>
        <p class="text-xs text-gray-400">{formattedDate}{review.time_spent && " â€¢ " + review.time_spent}</p>
    </div>

    <div class="flex flex-wrap gap-2">
        {tags.map(tag => (
            <span class="text-[12px] bg-white px-1 text-black uppercase tracking-wider">
                #{tag}
            </span>
        ))}
    </div>

    <p class="line-clamp-3 text-justify">
        {review.review_markdown}
    </p>

    <div class="mt-auto pt-4">
        <a href={`/review/${review.id}`} class="block w-full text-center bg-[#306f74] py-2 font-bold hover:bg-[#306f74]/50 hover:text-white transition-colors active:bg-black active:text-white">
            LER MAIS ->
        </a>
    </div>
  </div>
</article>

<script>
  const buttons = document.querySelectorAll('.share-btn');

  buttons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const path = btn.getAttribute('data-url');
      const fullUrl = window.location.origin + path;

      try {
        await navigator.clipboard.writeText(fullUrl);

        let remember = btn.innerHTML;
        btn.innerHTML = 'Link copiado!';
        setTimeout(() => {
          btn.innerHTML = remember;
        }, 1500);
        
      } catch (err) {
        console.error('Falha ao copiar:', err);
      }
    });
  });
</script>